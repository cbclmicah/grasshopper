/**
 * Copyright (c) 2015 "Fronteer LTD"
 * Grasshopper Event Engine
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

var _ = require('lodash');

var AuthConstants = require('gh-auth/lib/constants');
var GrassHopper = require('gh-core');

var UsersAPI = require('gh-users');

/**
 * @REST getUsers
 *
 * Get all users for an app
 *
 * @Server      admin
 * @Method      GET
 * @Path        /users
 * @QueryParam  {number}            [app]                   The id of the app to retrieve the users for
 * @QueryParam  {number}            [limit]                 The maximum number of results to retrieve. Default: 10
 * @QueryParam  {number}            [offset]                The paging number of the results to retrieve
 * @QueryParam  {string}            [q]                     The string to query users by
 * @Return      {UserList}                                  The users for the requested tenant or app
 */

/**
 * @REST getUsers
 *
 * Get the users in the current app
 *
 * @Server      app
 * @Method      GET
 * @Path        /users
 * @QueryParam  {number}            [limit]                 The maximum number of results to retrieve. Default: 10
 * @QueryParam  {number}            [offset]                The paging number of the results to retrieve
 * @QueryParam  {string}            [q]                     The string to query users by
 * @Return      {UserList}                                  The users for the current app
 */
var _getUsers = function(req, res) {
    var appId = req.query.app || req.ctx.app.id;
    UsersAPI.getUsers(req.ctx, appId, req.query.q, req.query.limit, req.query.offset, function(err, users) {
        if (err) {
            return res.status(err.code).send(err.msg);
        }

        return res.status(200).send({'results': users});
    });
};

GrassHopper.globalAdminRouter.on('get', '/api/users', _getUsers);
GrassHopper.appRouter.on('get', '/api/users', _getUsers);

/**
 * @REST getUser
 *
 * Get a user
 *
 * @Server      admin
 * @Method      GET
 * @Path        /users/{id}
 * @PathParam   {number}            id                      The id of the user to retrieve
 * @Return      {User}                                      The requested user
 */
var _getUser = function(req, res) {
    UsersAPI.getUser(req.ctx, req.params.id, function(err, user) {
        if (err) {
            return res.status(err.code).send(err.msg);
        }

        return res.status(200).send(user);
    });
};

GrassHopper.globalAdminRouter.on('get', '/api/users/:id', _getUser);
GrassHopper.appRouter.on('get', '/api/users/:id', _getUser);

/**
 * @REST getMe
 *
 * Get the current user
 *
 * @Server      app
 * @Method      GET
 * @Path        /me
 * @Return      {Me}                                        The current user
 */
GrassHopper.appRouter.on('get', '/api/me', function(req, res) {
    var me = {
        'anon': true,
        'app': req.ctx.app
    };
    if (req.ctx.user) {
        _.extend(me, {'anon': false}, req.ctx.user.toJSON());
    }
    _.extend(me, {'termsAndConditions': UsersAPI.getTermsAndConditionsStatus(req.ctx)});
    res.status(200).send(me);
});

/**
 * @REST getUserCalendar
 *
 * Get the calendar for a user
 *
 * @Server      admin,app
 * @Method      GET
 * @Path        /users/{id}/calendar
 * @PathParam   {number}            id                      The id of the user to get the calendar for
 * @QueryParam  {string}            start                   The timestamp (ISO 8601) from which to get the calendar for the user
 * @QueryParam  {string}            end                     The timestamp (ISO 8601) until which to get the calendar for the user
 * @Return      {Event[]}                                   The requested user calendar
 */
var _getUserCalendar = function(req, res) {
    UsersAPI.getUserCalendar(req.ctx, req.params.id, req.query.start, req.query.end, function(err, calendar) {
        if (err) {
            return res.status(err.code).send(err.msg);
        }

        return res.status(200).send({'results': calendar});
    });
};

GrassHopper.globalAdminRouter.on('get', '/api/users/:id/calendar', _getUserCalendar);
GrassHopper.appRouter.on('get', '/api/users/:id/calendar', _getUserCalendar);

/**
 * @REST getLecturerCalendar
 *
 * Get the calendar for a lecturer
 *
 * @Server      admin,app
 * @Method      GET
 * @Path        /users/{id}/lecturercalendar
 * @PathParam   {number}            id                      The id of the lecturer to get the calendar for
 * @QueryParam  {string}            start                   The timestamp (ISO 8601) from which to get the calendar for the lecturer
 * @QueryParam  {string}            end                     The timestamp (ISO 8601) until which to get the calendar for the lecturer
 * @Return      {Event[]}                                   The requested lecturer calendar
 */
var _getLecturerCalendar = function(req, res) {
    UsersAPI.getLecturerCalendar(req.ctx, req.params.id, req.query.start, req.query.end, function(err, calendar) {
        if (err) {
            return res.status(err.code).send(err.msg);
        }

        return res.status(200).send({'results': calendar});
    });
};

GrassHopper.globalAdminRouter.on('get', '/api/users/:id/lecturercalendar', _getLecturerCalendar);
GrassHopper.appRouter.on('get', '/api/users/:id/lecturercalendar', _getLecturerCalendar);

/**
 * @REST getUserCalendarIcal
 *
 * Get the calendar for a user in iCal
 *
 * @Server      admin,app
 * @Method      GET
 * @Path        /users/{id}/{token}/calendar.ical
 * @PathParam   {number}            id                      The id of the user to get the calendar for
 * @PathParam   {string}            token                   The access control token
 * @Return      {ical}                                      The requested user calendar in iCal format
 */
var _getUserCalendarIcal = function(req, res) {
    UsersAPI.getUserCalendarIcal(req.ctx, req.params.id, req.params.token, function(err, calendar) {
        if (err) {
            return res.status(err.code).send(err.msg);
        }

        res.set('Content-Type', 'text/calendar');
        return res.status(200).send(calendar);
    });
};

GrassHopper.globalAdminRouter.on('get', '/api/users/:id/:token/calendar.ical', _getUserCalendarIcal);
GrassHopper.appRouter.on('get', '/api/users/:id/:token/calendar.ical', _getUserCalendarIcal);

/**
 * @REST getUserCalendarRss
 *
 * Get the calendar for a user in RSS
 *
 * @Server      admin,app
 * @Method      GET
 * @Path        /users/{id}/{token}/calendar.rss
 * @PathParam   {number}            id                      The id of the user to get the calendar for
 * @PathParam   {string}            token                   The access control token
 * @Return      {rss}                                       The requested event series calendar in RSS format
 */
var _getUserCalendarRss = function(req, res) {
    UsersAPI.getUserCalendarRSS(req.ctx, req.params.id, req.params.token, function(err, calendar) {
        if (err) {
            return res.status(err.code).send(err.msg);
        }

        res.set('Content-Type', 'application/rss+xml');
        return res.status(200).send(calendar);
    });
};

GrassHopper.globalAdminRouter.on('get', '/api/users/:id/:token/calendar.rss', _getUserCalendarRss);
GrassHopper.appRouter.on('get', '/api/users/:id/:token/calendar.rss', _getUserCalendarRss);

/**
 * @REST resetUserCalendarToken
 *
 * Reset the user calendar token
 *
 * @Server      admin,app
 * @Method      POST
 * @Path        /users/{id}/token
 * @PathParam   {number}            id                      The id of the user to reset the calendar token for
 * @Return      {User}                                      The updated user
 */
var _resetUserCalendarToken = function(req, res) {
    UsersAPI.resetUserCalendarToken(req.ctx, req.params.id, function(err, user) {
        if (err) {
            return res.status(err.code).send(err.msg);
        }

        return res.status(200).send(user);
    });
};

GrassHopper.globalAdminRouter.on('post', '/api/users/:id/token', _resetUserCalendarToken);
GrassHopper.appRouter.on('post', '/api/users/:id/token', _resetUserCalendarToken);

/**
 * @REST getUserUpcoming
 *
 * Get the upcoming events for a user
 *
 * @Server      admin,app
 * @Method      GET
 * @Path        /users/{id}/upcoming
 * @PathParam   {number}            id                      The id of the user to get the upcoming events for
 * @QueryParam  {number}            [limit]                 The maximum number of results to retrieve. Default: 10
 * @QueryParam  {number}            [offset]                The paging number of the results to retrieve
 * @Return      {EventList}                                 The upcoming events for the user
 */
var _getUserUpcoming = function(req, res) {
    res.sendStatus(501);
};

GrassHopper.globalAdminRouter.on('get', '/api/users/:id/upcoming', _getUserUpcoming);
GrassHopper.appRouter.on('get', '/api/users/:id/upcoming', _getUserUpcoming);

/**
 * @REST acceptTermsAndConditions
 *
 * Accept the Terms and Conditions
 *
 * @Server      app
 * @Method      POST
 * @Path        /users/{id}/termsAndConditions
 * @PathParam   {number}            id                      The id of the user for which to accept the Terms and Conditions on the current app
 * @Return      {TermsAndConditionsStatus}                  The updated status of the Terms and Conditions for the user on the current app
 */
GrassHopper.appRouter.on('post', '/api/users/:id/termsAndConditions', function(req, res) {
    UsersAPI.acceptTermsAndConditions(req.ctx, req.params.id, function(err, termsAndConditionsStatus) {
        if (err) {
            return res.status(err.code).send(err.msg);
        }

        return res.status(200).send(termsAndConditionsStatus);
    });
});

/**
 * Create a new user with a local authentication strategy
 *
 * @param  {Object}                 req                     Express request object
 * @param  {Object}                 res                     Express response object
 * @param  {Number}                 appId                   The id of the app on which the user should be created
 * @api private
 */
var _createUser = function(req, res, appId) {
    // Extract the user profile properties
    var userProfile = {
        'displayName': req.body.displayName,
        'email': req.body.email,
        'emailPreference': req.body.emailPreference,
        'isAdmin': req.body.isAdmin
    };
    if (req.body.termsAndConditions === 'true') {
        userProfile.termsAndConditions = new Date();
    }

    // Extract the authentication credentials. The email address
    // will be used as the username
    var credentials = {
        'strategy': AuthConstants.strategies.LOCAL,
        'password': req.body.password
    };

    UsersAPI.createUser(req.ctx, appId, userProfile, credentials, function(err, user) {
        if (err) {
            return res.status(err.code).send(err.msg);
        }

        res.status(201).send(user);
    });
};

/**
 * @REST createUser
 *
 * Create a new user with a local authentication strategy
 *
 * @Server      admin
 * @Method      POST
 * @Path        /users
 * @FormParam   {number}            app                     The id of the app on which the user should be created
 * @FormParam   {string}            displayName             The name of the user
 * @FormParam   {string}            email                   The email address for the user. This will be used as the username for the user
 * @FormParam   {string}            password                The password with which the user will authenticate
 * @FormParam   {string}            [emailPreference]       The email preference for the user       [immediate,no]
 * @FormParam   {boolean}           [isAdmin]               Whether the user is an app administrator
 * @Return      {User}                                      The created user
 */
GrassHopper.globalAdminRouter.on('post', '/api/users', function(req, res) {
    return _createUser(req, res, req.body.app);
});

/**
 * @REST createUser
 *
 * Create a new user with a local authentication strategy
 *
 * @Server      app
 * @Method      POST
 * @Path        /users
 * @FormParam   {string}            displayName             The name of the user
 * @FormParam   {string}            email                   The email address for the user. This will be used as the username for the user
 * @FormParam   {string}            password                The password with which the user will authenticate
 * @FormParam   {string}            [emailPreference]       The email preference for the user    [immediate,no]
 * @FormParam   {boolean}           [isAdmin]               Whether the user is an app administrator
 * @FormParam   {string}            [recaptchaChallenge]    The identifier for the recaptcha challenge. Only required when the current user is not an app administrator
 * @FormParam   {string}            [recaptchaResponse]     The recaptcha response entered for the presented challenge. Only required when the current user is not an app administrator
 * @Return      {User}                                      The created user
 */
GrassHopper.appRouter.on('post', '/api/users', function(req, res) {
    // TODO: Recaptcha validation

    return _createUser(req, res, req.ghApp.id);
});

/**
 * @REST importUsers
 *
 * Import users using a CSV file
 *
 * The CSV file should be formatted in the following way:
 *
 *  `displayName, email, shibbolethId`
 *
 * When importing a set of users using the local authentication strategy, the CSV format should be the following:
 *
 *  `displayName, email, password`
 *
 * Keep in mind that when this request finishes, the actual import is still going on. Depending on the size
 * of your CSV file this might take a couple of minutes to complete
 *
 * @Server      admin
 * @Method      POST
 * @Path        /users/import
 * @FormParam   {string}            authenticationStrategy  The authentication strategy for the user    [local,shibboleth]
 * @FormParam   {File}              file                    The CSV file to import
 * @FormParam   {number}            [app]                   The id of the application into which the users should be imported. Defaults to the current application
 * @FormParam   {boolean}           [forceProfileUpdate]    Whether the user information should be updated, even when other user information is already present. Defaults to `false`
 * @Return      {void}
 */
GrassHopper.globalAdminRouter.on('post', '/api/users/import', function(req, res) {
    UsersAPI.importUsers(req.ctx, req.files.file, req.body.app, req.body.authenticationStrategy, req.body.forceProfileUpdate, function(err) {
        if (err) {
            return res.status(err.code).send(err.msg);
        }

        return res.status(200).send({});
    });
});

/**
 * @REST updateUser
 *
 * Update a user
 *
 * @Server      admin,app
 * @Method      POST
 * @Path        /users/{id}
 * @PathParam   {number}            id                      The id of the user to update
 * @FormParam   {string}            [displayName]           Updated user name
 * @FormParam   {string}            [email]                 Updated user email address
 * @FormParam   {string}            [emailPreference]       Updated user email preference on the current app    [immediate,no]
 * @Return      {User}                                      The updated user
 */
var _updateUser = function(req, res) {
    UsersAPI.updateUser(req.ctx, req.params.id, req.body, function(err, updatedUser) {
        if (err) {
            return res.status(err.code).send(err.msg);
        }

        return res.status(200).send(updatedUser);
    });
};

GrassHopper.globalAdminRouter.on('post', '/api/users/:id', _updateUser);
GrassHopper.appRouter.on('post', '/api/users/:id', _updateUser);

/**
 * @REST updateAdminStatus
 *
 * Update the app administrator status for a user
 *
 * @Server      admin,app
 * @Method      POST
 * @Path        /users/{id}/admin
 * @PathParam   {number}            id                      The id of the user to update the app administrator status for
 * @FormParam   {boolean}           admin                   Whether the user should be an app administrator
 * @Return      {User}                                      The updated user
 */
var _updateAdminStatus = function(req, res) {
    UsersAPI.updateAdminStatus(req.ctx, req.params.id, req.body.admin, function(err, updatedUser) {
        if (err) {
            return res.status(err.code).send(err.msg);
        }

        return res.status(200).send(updatedUser);
    });
};

GrassHopper.globalAdminRouter.on('post', '/api/users/:id/admin', _updateAdminStatus);
GrassHopper.appRouter.on('post', '/api/users/:id/admin', _updateAdminStatus);

/**
 * @REST setUserPicture
 *
 * Store a profile picture for a user
 *
 * @Server      admin,app
 * @Method      POST
 * @Path        /users/{id}/picture
 * @PathParam   {number}            id                      The id of the user to store the profile picture for
 * @FormParam   {File}              file                    Image that should be stored as the user profile picture
 * @Return      {User}                                      The updated user
 */
var _setUserPicture = function(req, res) {
    res.sendStatus(501);
};

GrassHopper.globalAdminRouter.on('post', '/api/users/:id/picture', _setUserPicture);
GrassHopper.appRouter.on('post', '/api/users/:id/picture', _setUserPicture);

/**
 * @REST cropUserPicture
 *
 * Crop the profile picture for a user
 *
 * @Server      admin,app
 * @Method      POST
 * @Path        /users/{id}/picture/crop
 * @FormParam   {number}            id                      The id of the user to crop the profile picture for
 * @FormParam   {number}            width                   The width of the square that needs to be cropped out
 * @FormParam   {number}            x                       The x coordinate of the top left corner to start cropping at
 * @FormParam   {number}            y                       The y coordinate of the top left corner to start cropping at
 * @Return      {User}                                      The updated user
 */
var _cropUserPicture = function(req, res) {
    res.sendStatus(501);
};

GrassHopper.globalAdminRouter.on('post', '/api/users/:id/picture/crop', _cropUserPicture);
GrassHopper.appRouter.on('post', '/api/users/:id/picture/crop', _cropUserPicture);
